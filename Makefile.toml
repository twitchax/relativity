# relativity ‚Äî cargo-make configuration
# Reference: https://github.com/twitchax/microralph/blob/main/Makefile.toml

# =============================================================================
# Tool Installation
# =============================================================================

[tasks.install-cargo-binstall]
# In CI, this is installed by the cargo-bins/cargo-binstall@main action.
# Locally, users should install manually: https://github.com/cargo-bins/cargo-binstall
script = "echo 'Checking cargo-binstall availability...'"

[tasks.install-nextest]
dependencies = ["install-cargo-binstall"]
command = "cargo"
args = ["binstall", "cargo-nextest", "--no-confirm"]

[tasks.install-llvm-cov]
dependencies = ["install-cargo-binstall"]
command = "cargo"
args = ["binstall", "cargo-llvm-cov", "--no-confirm"]

[tasks.install-cargo-release]
dependencies = ["install-cargo-binstall"]
command = "cargo"
args = ["binstall", "cargo-release", "--no-confirm"]

[tasks.install-git-cliff]
dependencies = ["install-cargo-binstall"]
command = "cargo"
args = ["binstall", "git-cliff", "--no-confirm"]

[tasks.tools]
dependencies = ["install-nextest", "install-llvm-cov"]

# =============================================================================
# Formatting
# =============================================================================

[tasks.fmt]
cwd = "."
workspace = false
command = "cargo"
args = ["fmt"]

[tasks.fmt-check]
cwd = "."
workspace = false
command = "cargo"
args = ["fmt", "--check"]

# =============================================================================
# Linting
# =============================================================================

[tasks.clippy]
cwd = "."
workspace = false
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

# =============================================================================
# Build
# =============================================================================

[tasks.build]
cwd = "."
workspace = false
command = "cargo"
args = ["build"]

[tasks.build-release]
cwd = "."
workspace = false
command = "cargo"
args = ["build", "--release"]

# =============================================================================
# Testing
# =============================================================================

[tasks.test]
cwd = "."
workspace = false
dependencies = ["install-nextest"]
command = "cargo"
args = ["nextest", "run"]

[tasks.test-cargo]
# Fallback for environments without nextest.
cwd = "."
workspace = false
command = "cargo"
args = ["test"]

# =============================================================================
# CI Pipeline
# =============================================================================

[tasks.ci]
# The full CI pipeline: fmt, clippy, test.
workspace = false
dependencies = ["fmt-check", "clippy", "test"]

# =============================================================================
# UAT (User Acceptance Tests)
# =============================================================================

[tasks.uat]
# The one true gate for this repo.
workspace = false
dependencies = ["ci"]

# =============================================================================
# Code Coverage
# =============================================================================

[tasks.codecov]
cwd = "."
workspace = false
clear = true
dependencies = ["tools"]
command = "cargo"
args = ["llvm-cov", "nextest", "--lcov", "--output-path", "coverage.lcov"]

[tasks.codecov-html]
cwd = "."
workspace = false
clear = true
dependencies = ["tools"]
command = "cargo"
args = ["llvm-cov", "nextest", "--html"]

# =============================================================================
# Platform Builds (for CI artifact generation)
# =============================================================================

[tasks.build-linux]
cwd = "."
workspace = false
command = "cargo"
args = ["build", "--target", "x86_64-unknown-linux-gnu", "--release"]

[tasks.build-windows]
cwd = "."
workspace = false
command = "cargo"
args = ["build", "--target", "x86_64-pc-windows-gnu", "--release"]

[tasks.build-macos]
cwd = "."
workspace = false
command = "cargo"
args = ["build", "--target", "aarch64-apple-darwin", "--release"]

# =============================================================================
# Web Build (Trunk / WASM)
# =============================================================================

[tasks.install-trunk]
dependencies = ["install-cargo-binstall"]
command = "cargo"
args = ["binstall", "trunk", "--no-confirm"]

[tasks.build-web]
cwd = "."
workspace = false
dependencies = ["install-trunk"]
command = "trunk"
args = ["build", "--release"]

# =============================================================================
# Publishing
# =============================================================================

[tasks.changelog]
cwd = "."
workspace = false
dependencies = ["install-git-cliff"]
command = "git-cliff"
args = ["--output", "CHANGELOG.md"]

[tasks.release-bump]
cwd = "."
workspace = false
dependencies = ["install-cargo-release"]
command = "cargo"
args = ["release", "--no-publish", "--execute"]

[tasks.release]
# Fully automated release: CI ‚Üí changelog ‚Üí bump ‚Üí commit ‚Üí push ‚Üí wait for artifacts
cwd = "."
workspace = false
dependencies = ["ci", "changelog", "install-cargo-release"]
script_runner = "@shell"
script = '''#!/bin/bash
set -e

echo ""
echo "üöÄ Starting automated release pipeline..."
echo ""

# Step 1: Version bump (cargo-release determines version from commits)
echo "üì¶ Step 1/5: Bumping version..."
cargo release --no-publish --execute

# Step 2: Extract new version from Cargo.toml
VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
echo "   ‚Üí New version: v$VERSION"

# Step 3: Commit changes
echo ""
echo "üìù Step 2/5: Committing changes..."
git add .
git commit -m "chore: release v$VERSION" || echo "   ‚Üí No changes to commit (already committed by cargo-release)"

# Step 4: Push to trigger CI
echo ""
echo "üöÄ Step 3/5: Pushing to remote..."
git push
git push --tags

# Step 5: Wait for CI and download artifacts
echo ""
echo "‚è≥ Step 4/5: Waiting for CI workflow to complete..."
echo "   This may take a few minutes..."

# Get the latest workflow run ID for the build workflow
sleep 5  # Give GitHub a moment to register the push
RUN_ID=""
for i in {1..60}; do
    RUN_ID=$(gh run list --branch main --workflow build.yml --limit 1 --json databaseId,status --jq '.[0] | select(.status != "completed") | .databaseId' 2>/dev/null || echo "")
    if [ -n "$RUN_ID" ]; then
        break
    fi
    sleep 2
done

if [ -z "$RUN_ID" ]; then
    # Try to get the most recent completed run
    RUN_ID=$(gh run list --branch main --workflow build.yml --limit 1 --json databaseId --jq '.[0].databaseId')
fi

if [ -n "$RUN_ID" ]; then
    echo "   ‚Üí Workflow run ID: $RUN_ID"
    gh run watch "$RUN_ID" --exit-status || {
        echo "‚ùå CI failed! Check the workflow at:"
        echo "   https://github.com/twitchax/relativity/actions/runs/$RUN_ID"
        exit 1
    }

    echo ""
    echo "üì• Step 5/5: Downloading artifacts..."
    rm -rf target/release-artifacts
    gh run download "$RUN_ID" --dir target/release-artifacts
    echo "   ‚Üí Artifacts downloaded to target/release-artifacts/"
else
    echo "‚ö†Ô∏è  Could not find workflow run. Download artifacts manually with:"
    echo "   gh run list --branch main --workflow build.yml --limit 1 --json databaseId --jq '.[0].databaseId' | xargs -I {} gh run download {} --dir target/release-artifacts"
fi

echo ""
echo "‚úÖ Release pipeline complete!"
echo ""
echo "Next steps:"
echo "  1. Create GitHub release: cargo make github-release v$VERSION"
'''

[tasks.publish-all]
cwd = "."
workspace = false
script_runner = "@shell"
script = '''#!/bin/bash
set -e

TAG=${1:-}
if [ -z "$TAG" ]; then
    echo "‚ùå Error: Version tag required"
    echo "Usage: cargo make publish-all <tag>"
    echo "Example: cargo make publish-all v0.1.0"
    exit 1
fi
shift  # Remove TAG from args, remaining args passed to github-release

echo "üöÄ Starting full publish pipeline for $TAG..."
echo ""

# Create GitHub release with artifacts
echo "üì¶ Creating GitHub release..."
cargo make github-release "$TAG" "$@"

echo ""
echo "‚úÖ Full publish pipeline complete!"
echo "   GitHub release: https://github.com/twitchax/relativity/releases/tag/$TAG"
'''

[tasks.github-release]
cwd = "."
workspace = false
script_runner = "@shell"
script = '''#!/bin/bash
set -e

TAG=${1:-}
if [ -z "$TAG" ]; then
    echo "‚ùå Error: Version tag required"
    echo "Usage: cargo make github-release <tag> [--draft]"
    echo "Example: cargo make github-release v0.1.0"
    exit 1
fi

echo "üì¶ Creating GitHub release for $TAG..."

# Prepare release notes
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT
NOTES_FILE="$TEMP_DIR/release_notes.md"

if [ -f "CHANGELOG.md" ]; then
    echo "Using changelog for release notes..."
    cp CHANGELOG.md "$NOTES_FILE"
else
    echo "## Release $TAG" > "$NOTES_FILE"
    echo "" >> "$NOTES_FILE"
    echo "See the full changelog at https://github.com/twitchax/relativity/blob/main/CHANGELOG.md" >> "$NOTES_FILE"
fi

# Check for artifacts directory and rename files for unique asset names
ARTIFACTS=""
STAGING_DIR=$(mktemp -d)
if [ -d "target/release-artifacts" ]; then
    echo "üìé Found target/release-artifacts directory"
    # Find all files recursively and rename using parent dir name
    for file in $(find target/release-artifacts -type f); do
        # Extract parent dir name (e.g., relativity_x86_64-unknown-linux-gnu)
        parent_dir=$(basename "$(dirname "$file")")
        filename=$(basename "$file")
        # Get extension if any
        if [[ "$filename" == *.* ]]; then
            ext=".${filename##*.}"
        else
            ext=""
        fi
        # Create unique name: relativity-x86_64-unknown-linux-gnu or relativity-x86_64-pc-windows-gnu.exe
        new_name="${parent_dir}${ext}"
        staged_file="$STAGING_DIR/$new_name"
        cp "$file" "$staged_file"
        echo "  ‚Üí $new_name"
        ARTIFACTS="$ARTIFACTS \"$staged_file\""
    done
fi

# Build gh release create command
GH_CMD="gh release create \"$TAG\" --title \"$TAG\" --notes-file \"$NOTES_FILE\""

# Add draft flag if requested
shift
if echo "$@" | grep -q "\-\-draft"; then
    GH_CMD="$GH_CMD --draft"
    echo "üìù Creating as draft release"
fi

# Add artifacts
if [ -n "$ARTIFACTS" ]; then
    GH_CMD="$GH_CMD $ARTIFACTS"
fi

# Execute the release creation
echo ""
echo "üöÄ Creating GitHub release..."
eval $GH_CMD

echo ""
echo "‚úÖ GitHub release created successfully!"
echo "   View at: https://github.com/twitchax/relativity/releases/tag/$TAG"
echo ""
echo "üí° To download artifacts from CI, run:"
echo "   gh run list --branch main --workflow build.yml --limit 1 --json databaseId --jq '.[0].databaseId' | xargs -I {} gh run download {} --dir target/release-artifacts"
'''

# =============================================================================
# Clean
# =============================================================================

[tasks.clean]
cwd = "."
workspace = false
command = "cargo"
args = ["clean"]
